<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Embeddable Threaded Discussion Board (Firebase Edition)</title>
  <style>
    :root {
      --bg:#000000;
      --panel:#111111;
      --muted:#aaaaaa;
      --text:#ffffff;
      --acc:#C5A95E;
      --acc2:#C5A95E;
      --danger:#ff6b6b;
      --line:#333333;
      --chip:#1a1a1a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    h1,h2,h3{margin:0 0 .25rem 0}
    a{color:var(--acc)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}

    .board{display:grid;grid-template-columns:260px 300px 1fr;gap:16px}
    @media (max-width: 980px){ .board{grid-template-columns:1fr;}}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 0 #0004, 0 20px 40px #0004}
    .card .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .card .bd{padding:12px 16px}

    .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;font-weight:600;cursor:pointer;background:var(--acc);color:#000;transition:.15s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px #0006;background:#d1b977;color:#000}
    .btn.secondary{background:var(--chip);color:var(--text)}
    .btn.secondary:hover{border:1px solid var(--acc);color:var(--acc)}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    .btn.ghost:hover{border-color:var(--acc);color:var(--acc)}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.danger:hover{opacity:0.9}

    .row{display:flex;gap:8px;flex-wrap:wrap}

    .list{display:flex;flex-direction:column;gap:8px}
    .item{padding:10px;border:1px solid var(--line);border-radius:12px;background:#0f0f0f;cursor:pointer;transition:.15s}
    .item:hover{border-color:var(--acc);background:#1a1a1a}
    .item.active{outline:2px solid var(--acc2)}
    .item h4{margin:0 0 2px 0;font-size:14px;color:var(--acc)}
    .meta{color:var(--muted);font-size:12px}

    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--acc)}

    .post{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0f0f0f}
    .post + .post{margin-top:8px}
    .post .title{font-weight:700;margin-bottom:6px;color:var(--acc)}
    .post .content{white-space:pre-wrap}
    .post .author{font-size:12px;color:var(--muted)}

    .reply{margin-left:24px;border-left:3px solid var(--acc);padding-left:12px}

    form{display:grid;gap:10px}
    label{font-weight:600;font-size:12px;color:var(--muted)}
    input, textarea, select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#000;color:var(--text)}
    input:focus, textarea:focus, select:focus{outline:2px solid var(--acc)}
    textarea{min-height:120px;resize:vertical}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .two{grid-template-columns:1fr}}
    .help{font-size:12px;color:var(--muted)}
    .empty{color:var(--muted);padding:8px}
    .toolbar{display:flex;gap:8px;align-items:center}
    .sep{height:1px;background:var(--line);margin:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Discussion Board</h1>
    <p class="help">Main topics → subtopics → original post with replies. Shared globally via Firebase.</p>

    <div class="board">
      <div class="card" id="topicsCard">
        <div class="hd">
          <strong>Topics</strong>
          <button class="btn" id="addTopicBtn">+ Topic</button>
        </div>
        <div class="bd">
          <div class="list" id="topicsList"></div>
        </div>
      </div>

      <div class="card" id="subtopicsCard">
        <div class="hd">
          <div class="toolbar">
            <strong>Subtopics</strong>
            <span class="pill" id="currentTopicPill">None</span>
          </div>
          <button class="btn" id="addSubtopicBtn">+ Subtopic</button>
        </div>
        <div class="bd">
          <div class="list" id="subtopicsList"></div>
        </div>
      </div>

      <div class="card" id="threadsCard">
        <div class="hd">
          <div class="toolbar">
            <strong>Threads</strong>
            <span class="pill" id="currentSubtopicPill">None</span>
          </div>
          <div class="row">
            <button class="btn" id="newThreadBtn">+ New Thread</button>
            <button class="btn secondary" id="exportBtn" title="Export current subtopic to JSON">Export</button>
          </div>
        </div>
        <div class="bd" id="threadsBody">
          <div class="empty">Pick a subtopic to view or start a thread.</div>
        </div>
      </div>
    </div>
  </div>

  <template id="topicItemTpl">
    <div class="item"><h4></h4><div class="meta"></div></div>
  </template>
  <template id="subtopicItemTpl">
    <div class="item"><h4></h4><div class="meta"></div></div>
  </template>
  <template id="postTpl">
    <div class="post">
      <div class="title"></div>
      <div class="content"></div>
      <div class="author"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn secondary replyBtn">Reply</button>
        <button class="btn ghost delBtn" style="display:none">Delete</button>
      </div>
    </div>
  </template>

  <div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#0008;backdrop-filter:saturate(140%) blur(6px)">
    <div class="card" style="width:min(680px,92vw)">
      <div class="hd"><strong id="modalTitle">Modal</strong><button class="btn ghost" id="modalClose">Close</button></div>
      <div class="bd" id="modalBody"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, where, orderBy, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFWCyeoF-lGG2z7wpXCuLOZkO0TaYw1-M",
      authDomain: "one-summit-discussion-board.firebaseapp.com",
      projectId: "one-summit-discussion-board",
      storageBucket: "one-summit-discussion-board.firebasestorage.app",
      messagingSenderId: "595878395925",
      appId: "1:595878395925:web:d55da77e2c0e6a1bbb4e1c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUid = null;
    await signInAnonymously(auth);
    onAuthStateChanged(auth, (user)=>{ currentUid = user?.uid || null; });

    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    let state = { topics: [], subtopics: [], posts: [] };
    let current = { topicId: null, subtopicId: null };

    function modal(title, contentNode){
      $('#modalTitle').textContent = title;
      const body = $('#modalBody');
      body.innerHTML = '';
      body.appendChild(contentNode);
      $('#modal').style.display = 'flex';
    }
    function closeModal(){ $('#modal').style.display='none'; }
    $('#modalClose').addEventListener('click', closeModal);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    function notify(msg){
      const n = document.createElement('div');
      n.textContent = msg;
      n.style.position='fixed';n.style.right='16px';n.style.bottom='16px';n.style.background='var(--panel)';
      n.style.border='1px solid var(--line)';n.style.padding='10px 12px';n.style.borderRadius='12px';
      n.style.boxShadow='0 12px 30px #0006';n.style.zIndex='9999';
      document.body.appendChild(n);
      setTimeout(()=>n.remove(), 1600);
    }

    let unsubscribeTopics = null;
    let unsubscribeSubtopics = null;
    let unsubscribePosts = null;

    function watchTopics(){
      if (unsubscribeTopics) unsubscribeTopics();
      const q = query(collection(db, 'topics'), orderBy('createdAt', 'desc'));
      unsubscribeTopics = onSnapshot(q, (snap)=>{
        state.topics = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
        renderTopics();
        renderSubtopics();
      });
    }

    function watchSubtopics(topicId){
      if (unsubscribeSubtopics) unsubscribeSubtopics();
      if (!topicId){ state.subtopics = []; renderSubtopics(); return; }
      const q = query(collection(db, 'subtopics'), where('topicId','==', topicId), orderBy('createdAt', 'desc'));
      unsubscribeSubtopics = onSnapshot(q, (snap)=>{
        state.subtopics = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
        renderSubtopics();
      });
    }

    function watchPosts(subtopicId){
      if (unsubscribePosts) unsubscribePosts();
      if (!subtopicId){ state.posts = []; renderThreads(); return; }
      const q = query(collection(db, 'posts'), where('subtopicId','==', subtopicId), orderBy('createdAt', 'desc'));
      unsubscribePosts = onSnapshot(q, (snap)=>{
        state.posts = snap.docs.map(d=> ({ id: d.id, ...d.data() }));
        renderThreads();
      });
    }

    function renderTopics(){
      const list = $('#topicsList');
      list.innerHTML = '';
      if(state.topics.length===0){ list.innerHTML = '<div class="empty">No topics yet.</div>'; return; }
      const tpl = $('#topicItemTpl');
      state.topics.forEach(t=>{
        const el = tpl.content.firstElementChild.cloneNode(true);
        $('h4', el).textContent = t.title;
        $('.meta', el).textContent = t.createdAt?.toDate ? `Created ${t.createdAt.toDate().toLocaleDateString()}` : '';
        if(current.topicId===t.id) el.classList.add('active');
        el.addEventListener('click', ()=>{
          current.topicId = t.id; current.subtopicId = null;
          watchSubtopics(current.topicId);
          watchPosts(null);
          render();
        });
        list.appendChild(el);
      });
    }

    function renderSubtopics(){
      const pill = $('#currentTopicPill');
      const list = $('#subtopicsList');
      list.innerHTML = '';
      const topic = state.topics.find(t=>t.id===current.topicId);
      pill.textContent = topic ? topic.title : 'None';
      if(!topic){ list.innerHTML = '<div class="empty">Select a topic.</div>'; return; }
      const subs = state.subtopics;
      if(subs.length===0){ list.innerHTML = '<div class="empty">No subtopics yet.</div>'; return; }
      const tpl = $('#subtopicItemTpl');
      subs.forEach(s=>{
        const el = tpl.content.firstElementChild.cloneNode(true);
        $('h4', el).textContent = s.title;
        $('.meta', el).textContent = s.createdAt?.toDate ? `Created ${s.createdAt.toDate().toLocaleDateString()}` : '';
        if(current.subtopicId===s.id) el.classList.add('active');
        el.addEventListener('click', ()=>{ current.subtopicId=s.id; watchPosts(current.subtopicId); renderThreads(); });
        list.appendChild(el);
      });
    }

    function renderThreads(){
      const pill = $('#currentSubtopicPill');
      const body = $('#threadsBody');
      body.innerHTML = '';
      const sub = state.subtopics.find(s=>s.id===current.subtopicId);
      pill.textContent = sub ? sub.title : 'None';
      if(!sub){ body.innerHTML = '<div class="empty">Pick a subtopic to view or start a thread.</div>'; return; }

      const roots = state.posts.filter(p=>!p.parentPostId);
      if(roots.length===0){ body.innerHTML = '<div class="empty">No threads yet. Start one!</div>'; return; }

      const tpl = $('#postTpl');
      roots.forEach(root=>{
        const rootEl = renderPost(tpl, root);
        body.appendChild(rootEl);
        const replies = state.posts.filter(p=>p.parentPostId===root.id).sort((a,b)=>{
          const ad = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
          const bd = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
          return ad - bd;
        });
        replies.forEach(r=>{
          const el = renderPost(tpl, r);
          el.classList.add('reply');
          body.appendChild(el);
        });
      });
    }

    function renderPost(tpl, post){
      const el = tpl.content.firstElementChild.cloneNode(true);
      $('.title', el).textContent = post.title || '(no title)';
      $('.content', el).textContent = post.content || '';
      const when = post.createdAt?.toDate ? post.createdAt.toDate().toLocaleString() : '';
      const whoText = `${post.firstName||''} ${post.lastName||''} • ${post.city||''}${post.state?`, ${post.state}`:''} ${when?`• ${when}`:''}`.trim();
      const mail = document.createElement('a'); mail.href = `mailto:${post.email||''}`; mail.textContent = post.email||'';
      const meta = document.createElement('div'); meta.className='author'; meta.textContent = whoText + (post.email? ' • ' : ''); if(post.email
